<!DOCTYPE html>
<html lang="tr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIQ-Alg 0CO2: Hava Kalitesi Paneli</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Montserrat:wght@700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f8f9fa; color: #073B4C; }
        .font-heading { font-family: 'Montserrat', sans-serif; }
        .chart-container { position: relative; width: 100%; max-width: 550px; margin: auto; height: 320px; }
        @media (min-width: 768px) { .chart-container { height: 400px; } }
        .kpi-card { background: #ffffff; border-radius: 0.75rem; padding: 1rem; text-align: center; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .nav-link.active { color: #118AB2; font-weight: 700; }
        [title]:hover { cursor: help; }
        .chat-message { margin-bottom: 1rem; display: flex; }
        .chat-message.user { justify-content: flex-end; }
        .chat-message.ai { justify-content: flex-start; }
        .chat-message p { padding: 0.75rem 1.25rem; border-radius: 1.25rem; max-width: 85%; text-align: left; line-height: 1.5; }
        .chat-message.user p { background-color: #118AB2; color: white; border-bottom-right-radius: 0.25rem; }
        .chat-message.ai p { background-color: #E9ECEF; color: #073B4C; border-bottom-left-radius: 0.25rem; }
        #chat-submit:disabled { background-color: #9ca3af; cursor: not-allowed; }
    </style>
</head>

<body class="antialiased">

    <header class="bg-white/95 backdrop-blur-sm sticky top-0 z-50 shadow-md">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="#hero" class="flex items-center">
                <img src="logo111.png" alt="BIQ-Alg 0CO2 Proje Logosu" class="h-12 w-auto" onerror="this.onerror=null; this.src='https://placehold.co/150x50/FFFFFF/073B4C?text=BiQ-Alg+0CO2';">
            </a>
            <div class="hidden md:flex items-center space-x-8">
                <a href="#problem-solution" class="nav-link text-gray-600 hover:text-[#118AB2] font-semibold transition-colors">Çözüm</a>
                <a href="#technology" class="nav-link text-gray-600 hover:text-[#118AB2] font-semibold transition-colors">Teknoloji</a>
                <a href="#live-data" class="nav-link text-gray-600 hover:text-[#118AB2] font-semibold transition-colors">Canlı Veri</a>
                <a href="#city-comparison" class="nav-link text-gray-600 hover:text-[#118AB2] font-semibold transition-colors">Karşılaştırma</a>
                <a href="#ai-chat-section" class="nav-link text-gray-600 hover:text-[#118AB2] font-semibold transition-colors">Yapay Zeka</a>
            </div>
        </nav>
    </header>

    <main>
        <section id="hero" class="py-20 md:py-32" style="background: linear-gradient(135deg, #118AB2 0%, #06D6A0 100%);">
            <div class="container mx-auto px-6 text-center text-white">
                <h1 class="text-4xl md:text-6xl font-bold font-heading mb-4 tracking-tight">Afet Sonrası Temiz Nefes: <br> BIQ-Alg 0CO2</h1>
                <p class="text-lg md:text-xl max-w-3xl mx-auto opacity-90">
                    Doğanın en güçlü savaşçıları olan mikroalgler ile afet bölgelerine anında hava kalitesi, sürdürülebilir enerji ve umut taşıyan mobil eğitim istasyonunu keşfedin.
                </p>
            </div>
        </section>

        <section id="problem-solution" class="py-16 md:py-24">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12 md:mb-16">
                    <h2 class="text-3xl md:text-4xl font-bold font-heading text-[#073B4C]">Görünmez Tehlikeye Karşı Biyolojik Kalkan</h2>
                </div>
                <div class="grid md:grid-cols-3 gap-8 items-center text-center">
                    <div class="bg-white p-8 rounded-xl shadow-lg">
                        <h3 class="font-heading text-2xl font-bold text-[#FF6B6B] mb-3">GELENEKSEL YÖNTEMLER</h3>
                        <p class="text-gray-600">Enerji yoğun, maliyetli ve sadece partikül filtreler. CO₂ yakalama veya O₂ üretme yetenekleri yoktur.</p>
                    </div>
                    <div class="p-8">
                         <div class="text-6xl md:text-8xl font-black text-[#118AB2] font-heading">50x</div>
                         <p class="font-bold text-xl mt-2 text-[#073B4C]">DAHA VERİMLİ</p>
                         <p class="text-gray-600 mt-1">Mikroalgler, karasal bitkilere göre 10 ila 50 kat daha verimli CO₂ yakalar.</p>
                    </div>
                    <div class="bg-white p-8 rounded-xl shadow-lg">
                        <h3 class="font-heading text-2xl font-bold text-[#06D6A0] mb-3">MİKROALG ÇÖZÜMÜ</h3>
                        <p class="text-gray-600">Havayı temizler, oksijen üretir ve döngüsel ekonomi için değerli biyokütle oluşturur.</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="technology" class="py-16 md:py-24 bg-gray-100">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12 md:mb-16">
                    <h2 class="text-3xl md:text-4xl font-bold font-heading text-[#073B4C]">Hava Arıtmanın Kalbi: Fotobiyoreaktör (FBR) Teknolojileri</h2>
                    <p class="mt-4 text-lg text-[#073B4C] max-w-3xl mx-auto">
                        Mikroalglerin gücünü en verimli şekilde kullanmak için farklı reaktör tasarımları mevcuttur. Her birinin kendine özgü avantajları ve performans metrikleri bulunur. Projemiz, mobilite ve verimliliği birleştiren Dikey Tübüler FBR tasarımını temel alır.
                    </p>
                </div>
                <div class="grid md:grid-cols-2 gap-8 items-center">
                    <div class="chart-container">
                        <canvas id="pbrPerformanceChart"></canvas>
                    </div>
                    <div id="pbr-info" class="space-y-4">
                        <div class="bg-white p-6 rounded-lg shadow-md transition-all duration-300">
                             <h3 class="text-xl font-bold font-heading mb-2 text-[#118AB2]">Dikey Tübüler FBR (Projemizin Seçimi)</h3>
                            <p class="text-gray-600">Kompakt yapısıyla mobil uygulamalar için idealdir. Kontrollü ortamı sayesinde yüksek verimlilik ve stabilite sunar. Az yer kaplar ve afet bölgelerinde hızla kurulabilir.</p>
                        </div>
                         <div class="bg-white p-6 rounded-lg shadow-md transition-all duration-300 opacity-70">
                             <h3 class="text-xl font-bold font-heading mb-2 text-[#073B4C]">Düz Panel FBR</h3>
                            <p class="text-gray-600">Yüksek ışık verimliliği sağlar ancak genellikle daha büyük ve sabit kurulumlar için uygundur.</p>
                        </div>
                         <div class="bg-white p-6 rounded-lg shadow-md transition-all duration-300 opacity-70">
                             <h3 class="text-xl font-bold font-heading mb-2 text-[#073B4C]">Açık Havuz Sistemleri</h3>
                            <p class="text-gray-600">Düşük maliyetlidir ancak kirlenme riski yüksek ve verimliliği düşüktür.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="live-data" class="py-16 md:py-24 bg-gray-100">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12 md:mb-16">
                    <h2 class="text-3xl md:text-4xl font-bold font-heading text-[#073B4C]">Cihazdan Gelen Canlı Veriler</h2>
                    <p class="mt-4 text-lg text-[#073B4C] max-w-3xl mx-auto">
                        BIQ-Alg 0CO2 istasyonundan gelen gerçek zamanlı sensör verilerini buradan takip edin.
                    </p>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8 text-center">
                    <div class="kpi-card p-4"><h4 class="font-bold text-gray-500 text-sm">CO₂ SEVİYESİ</h4><p id="kpi-co2" class="text-3xl font-black text-[#118AB2] mt-1">--- <span class="text-lg">ppm</span></p></div>
                    <div class="kpi-card p-4"><h4 class="font-bold text-gray-500 text-sm">HAVA KALİTESİ</h4><p id="kpi-air-quality" class="text-3xl font-black text-[#06D6A0] mt-1">---</p></div>
                    <div class="kpi-card p-4"><h4 class="font-bold text-gray-500 text-sm">IŞIK ŞİDDETİ</h4><p id="kpi-light" class="text-3xl font-black text-[#FFD166] mt-1">--- <span class="text-lg">lux</span></p></div>
                    <div class="kpi-card p-4"><h4 class="font-bold text-gray-500 text-sm">SICAKLIK</h4><p id="kpi-temp" class="text-3xl font-black text-[#FF6B6B] mt-1">-- <span class="text-lg">°C</span></p></div>
                    <div class="kpi-card p-4"><h4 class="font-bold text-gray-500 text-sm">NEM</h4><p id="kpi-humidity" class="text-3xl font-black text-[#118AB2] mt-1">-- <span class="text-lg">%</span></p></div>
                    <div class="kpi-card p-4"><h4 class="font-bold text-gray-500 text-sm">SU KALİTESİ (TDS)</h4><p id="kpi-tds" class="text-3xl font-black text-[#EF476F] mt-1">--- <span class="text-lg">ppm</span></p></div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-bold font-heading text-center mb-4 text-[#073B4C]">CO₂ Seviyesi Trendi</h3><div class="chart-container" style="height: 300px;"><canvas id="co2Chart"></canvas></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-bold font-heading text-center mb-4 text-[#073B4C]">Su Kalitesi Trendi (TDS)</h3><div class="chart-container" style="height: 300px;"><canvas id="tdsChart"></canvas></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-bold font-heading text-center mb-4 text-[#073B4C]">Işık Şiddeti Trendi</h3><div class="chart-container" style="height: 300px;"><canvas id="lightChart"></canvas></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-bold font-heading text-center mb-4 text-[#073B4C]">Sıcaklık ve Nem Trendi</h3><div class="chart-container" style="height: 300px;"><canvas id="tempHumidityChart"></canvas></div></div>
                </div>
                <div class="text-center mt-12">
                    <button id="download-csv-button" class="bg-[#073B4C] text-white font-bold py-3 px-6 rounded-lg hover:bg-[#118AB2] transition-colors shadow-md">
                        Grafik Verilerini Kaydet (CSV)
                    </button>
                </div>
            </div>
        </section>

        <!-- YENİ BÖLÜM: Optimum Koşullar -->
        <section id="optimal-conditions" class="py-16 md:py-24">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12 md:mb-16">
                    <h2 class="text-3xl md:text-4xl font-bold font-heading text-[#073B4C]">Mikroalgler için Optimum Yaşam Koşulları</h2>
                    <p class="mt-4 text-lg text-[#073B4C] max-w-3xl mx-auto">
                        Sistemin verimliliği, mikroalglerin fotosentez yapabilmesi için gerekli olan ortam koşullarının ideal aralıklarda tutulmasına bağlıdır.
                    </p>
                </div>
                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8 text-center">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#FFD166" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg>
                        <h3 class="font-heading text-xl font-bold mb-2">Işık Şiddeti</h3>
                        <p class="text-gray-600">Fotosentez için temel enerji kaynağıdır. İdeal aralık **400-1000 lux** arasıdır. Düşük ışık verimi azaltır, aşırı yüksek ışık ise hücrelere zarar verebilir.</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#FF6B6B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4"><path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z"></path></svg>
                        <h3 class="font-heading text-xl font-bold mb-2">Sıcaklık</h3>
                        <p class="text-gray-600">Metabolik aktiviteleri doğrudan etkiler. Çoğu mikroalg türü için en verimli aralık **20-30 °C**'dir. Bu aralığın dışı büyümeyi yavaşlatır.</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#EF476F" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4"><path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5-2 1.6-3 3.5-3 5.5a7 7 0 0 0 7 7z"></path></svg>
                        <h3 class="font-heading text-xl font-bold mb-2">Su Kalitesi (TDS)</h3>
                        <p class="text-gray-600">Alglerin besin alımı için kritiktir. İdeal aralık **100-500 ppm**'dir. Çok düşük TDS besin eksikliği, çok yüksek TDS ise zehirlenme yaratır.</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#118AB2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4"><path d="M5 17a2 2 0 0 1 2 2v2"></path><path d="M17 17a2 2 0 0 0 2 2v2"></path><path d="M17 17a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2"></path><path d="M9 15v-3a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v3"></path><path d="M12 10V4a2 2 0 0 0-2-2H8"></path></svg>
                        <h3 class="font-heading text-xl font-bold mb-2">Nem</h3>
                        <p class="text-gray-600">Doğrudan algleri etkilemese de, sistemin genel buharlaşma oranını ve sıcaklık dengesini etkileyen ikincil bir faktördür. İdeal aralık **40-60%**'tır.</p>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="city-comparison" class="py-16 md:py-24">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12 md:mb-16">
                    <h2 class="text-3xl md:text-4xl font-bold font-heading text-[#073B4C]">Deprem Bölgeleri Hava Kalitesi Karşılaştırması</h2>
                    <p class="mt-4 text-lg text-[#073B4C] max-w-3xl mx-auto">
                        BIQ-Alg istasyonunun (İstanbul) anlık hava temizleme performansını, diğer deprem bölgesi şehirlerinin genel durumuyla karşılaştırın.
                    </p>
                </div>
                <div class="overflow-x-auto bg-white rounded-xl shadow-lg mb-8">
                    <table class="w-full text-left">
                        <thead class="bg-[#073B4C] text-white">
                            <tr>
                                <th class="p-4 font-bold uppercase tracking-wider">Şehir</th>
                                <th class="p-4 font-bold uppercase tracking-wider">Hava Kalite İndeksi (HKİ)</th>
                                <th class="p-4 font-bold uppercase tracking-wider">Durum</th>
                                <th class="p-4 font-bold uppercase tracking-wider">Ana Kirletici</th>
                                <th class="p-4 font-bold uppercase tracking-wider">Ölçüm Tarihi</th>
                            </tr>
                        </thead>
                        <tbody id="comparison-table-body" class="divide-y divide-gray-200">
                             <tr><td colspan="5" class="p-8 text-center text-gray-500">Veriler yükleniyor...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-6 p-4 bg-blue-100 border-l-4 border-blue-500 text-blue-800 rounded-r-lg">
                    <h4 class="font-bold">Veri Kaynağı Hakkında</h4>
                    <p class="text-sm mt-1">Karşılaştırma verileri, dünya genelinde 30,000'den fazla istasyondan veri toplayan kâr amacı gütmeyen bir kuruluş olan <strong>World Air Quality Index Project</strong> tarafından sağlanmaktadır. Bu platform, vatandaşların yaşadıkları yerdeki hava kirliliği hakkında bilinçlenmesine yardımcı olmayı hedefler.</p>
                </div>
            </div>
        </section>

        <section id="ai-chat-section" class="py-16 md:py-24 bg-gray-100">
             <div class="container mx-auto px-6">
                <div class="bg-white p-6 rounded-xl shadow-lg max-w-4xl mx-auto">
                    <h3 class="text-2xl font-bold font-heading text-center mb-4 text-[#073B4C]">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2 -mt-1"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path><path d="m15 5 4 4"></path></svg>
                        Yapay Zeka Asistanı ile Sohbet Edin
                    </h3>
                    <div id="chat-container" class="h-80 overflow-y-auto p-4 border rounded-lg mb-4 bg-gray-50">
                        <div class="chat-message ai">
                            <p>Merhaba! Ben BIQ-Alg asistanıyım. Projemiz veya anlık sensör verileri hakkında merak ettiklerinizi sorabilirsiniz.</p>
                        </div>
                    </div>
                    <form id="chat-form" class="flex gap-2">
                        <input type="text" id="chat-input" placeholder="Sorunuzu buraya yazın..." class="flex-grow p-3 border rounded-lg focus:ring-2 focus:ring-[#118AB2] focus:outline-none">
                        <button type="submit" id="chat-submit" class="bg-[#073B4C] text-white font-bold py-2 px-5 rounded-lg hover:bg-[#118AB2] transition-colors flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                        </button>
                    </form>
                </div>
            </div>
        </section>

        <section id="summary-table-section" class="py-16 md:py-24">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12 md:mb-16">
                    <h2 class="text-3xl md:text-4xl font-bold font-heading text-[#073B4C]">Projenin Öne Çıkan Yönleri</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left rounded-lg shadow-lg overflow-hidden">
                        <thead class="bg-[#118AB2] text-white">
                            <tr>
                                <th class="p-4 font-bold uppercase tracking-wider w-1/3">Özellik / Alan</th>
                                <th class="p-4 font-bold uppercase tracking-wider">Açıklama ve Hedef</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 bg-white">
                            <tr class="hover:bg-gray-50">
                                <td class="p-4 font-semibold text-[#073B4C]">Problem Odaklı Geliştirme</td>
                                <td class="p-4 text-gray-700">Türkiye'de yaşanılan 6 Şubat deprem felaketindeki atmosfer verileri toplanmış ve sistemin geliştirilmesinde bu verilerden yararlanılmıştır. (Kaynak: MGM, Akademik Yayınlar).</td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="p-4 font-semibold text-[#073B4C]">Mobilite ve Anlık Analiz</td>
                                <td class="p-4 text-gray-700">İstasyon mobil bir yapıdadır. Geliştirilen sistem, afet bölgesindeki atmosfer verilerini (CO₂, PM2.5 vb.) anlık olarak analiz eder, bölgedeki hava kalitesi hakkında bilgi verir ve bu verileri kayıt altına alır.</td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="p-4 font-semibold text-[#073B4C]">Çok Yönlü Fayda</td>
                                <td class="p-4 text-gray-700">Sistem; afetzedeler için deneyimsel öğrenme ortamı oluşturur, hava kalitesini iyileştirir, ürettiği biyokütle ile döngüsel ekonomiye katkıda bulunur ve ürettiği oksijen ile daha sağlıklı bir yaşam ortamı sağlar.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>

    <footer class="bg-[#073B4C] text-white py-8">
        <div class="container mx-auto px-6 text-center">
            <p>&copy; 2025 BIQ-Alg 0CO2 Projesi. Tüm Hakları Saklıdır.</p>
        </div>
    </footer>
    
    <div id="message-box" class="message-box"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, collection, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', function () {
            
            const AQI_API_TOKEN = "08039ad9c3603305b99fc2bcaf155da6e0bfdc31"; 
            const CITIES = ["Hatay", "Van", "Kahramanmaraş", "Gaziantep", "Eskişehir", "Mersin", "Ankara", "Izmir", "Bursa", "Zonguldak"];
            const GEMINI_API_KEY = "AIzaSyBeXmWsCfg_ruCHn9fCB9-CaUfe-T_UeFg";
            
            const firebaseConfig = {
                apiKey: "AIzaSyBvJNWLHjMqlhAdZXSBqHQuPNnnImNZd4Q",
                authDomain: "biqalgco2-hava-istasyonu.firebaseapp.com",
                databaseURL: "https://biqalgco2-hava-istasyonu-default-rtdb.firebaseio.com",
                projectId: "biqalgco2-hava-istasyonu",
                storageBucket: "biqalgco2-hava-istasyonu.appspot.com",
                messagingSenderId: "1014289654311",
                appId: "1:1014289654311:web:e37e2a3ffe78a3cc4ba402"
            };
            
            let db;
            let lastHistoryData = [];
            let latestSensorData = null;
            let allCityData = [];
            let chatHistory = []; 

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const auth = getAuth(app);
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        startRealtimeListeners();
                        loadExternalCityData();
                        setupAiChat();
                    } else {
                        signInAnonymously(auth);
                    }
                });
            } catch(e) { console.error("Firebase başlatma hatası:", e); }
            
            const POLLUTANT_INFO = {
                pm25: "İnce Partikül Madde (PM2.5)",
                pm10: "Kaba Partikül Madde (PM10)",
                o3: "Ozon (O₃)",
                no2: "Azot Dioksit (NO₂)",
                so2: "Kükürt Dioksit (SO₂)",
                co: "Karbon Monoksit (CO)"
            };

            function getAqiStatus(aqi) {
                if (aqi <= 50) return { text: 'İyi', color: 'bg-green-500', textColor: 'text-green-700' };
                if (aqi <= 100) return { text: 'Orta', color: 'bg-yellow-500', textColor: 'text-yellow-700' };
                if (aqi <= 150) return { text: 'Hassas', color: 'bg-orange-500', textColor: 'text-orange-700' };
                if (aqi <= 200) return { text: 'Sağlıksız', color: 'bg-red-500', textColor: 'text-red-700' };
                if (aqi <= 300) return { text: 'Çok Sağlıksız', color: 'bg-purple-700', textColor: 'text-purple-700' };
                return { text: 'Tehlikeli', color: 'bg-red-900', textColor: 'text-red-900' };
            }
            
            function getAirQualityStatus(co2) {
                if (co2 <= 0) return { text: "---", color: "text-gray-500" };
                if (co2 <= 1000) return { text: "İyi", color: "text-[#06D6A0]" };
                if (co2 <= 2000) return { text: "Orta", color: "text-yellow-500" };
                return { text: "Kötü", color: "text-red-500" };
            }

            async function fetchAirQualityData(city) {
                try {
                    const response = await fetch(`https://api.waqi.info/feed/${city}/?token=${AQI_API_TOKEN}`);
                    if (!response.ok) return null;
                    const jsonResponse = await response.json();
                    return jsonResponse.data;
                } catch (error) {
                    console.error(`Hata (${city}):`, error);
                    return null;
                }
            }

            async function loadExternalCityData() {
                const tableBody = document.getElementById('comparison-table-body');
                if (!tableBody) return;
                
                const istanbulPromise = fetchAirQualityData('Istanbul');
                const otherCitiesPromises = CITIES.map(city => fetchAirQualityData(city));
                
                const [istanbulData, ...otherCitiesData] = await Promise.all([istanbulPromise, ...otherCitiesPromises]);
                
                allCityData = [{city: 'Istanbul', data: istanbulData}, ...CITIES.map((city, i) => ({city, data: otherCitiesData[i]}))];
                
                updateComparisonTable();
            }

            function updateComparisonTable() {
                const tableBody = document.getElementById('comparison-table-body');
                if (!tableBody) return;
                tableBody.innerHTML = '';

                // Önce BIQ-Alg istasyonunu ekle
                if (latestSensorData) {
                    const localStatus = getAirQualityStatus(latestSensorData.co2);
                    const istanbulData = allCityData.find(c => c.city === 'Istanbul')?.data;
                    const mainPollutant = istanbulData ? (POLLUTANT_INFO[istanbulData.dominentpol] || istanbulData.dominentpol.toUpperCase()) : 'CO₂';
                    const measurementDate = latestSensorData.timestamp?.toDate ? latestSensorData.timestamp.toDate().toLocaleString('tr-TR') : '...';

                    tableBody.innerHTML += `
                        <tr class="bg-blue-50">
                            <td class="p-4 font-semibold text-[#073B4C]">BIQ-Alg İstasyonu (İstanbul)</td>
                            <td class="p-4 font-bold text-lg">${parseFloat(latestSensorData.co2).toFixed(2)}</td>
                            <td class="p-4"><span class="px-3 py-1 text-sm font-bold rounded-full ${localStatus.color.replace('text', 'bg').replace('-500', '-200')} ${localStatus.color}">${localStatus.text}</span></td>
                            <td class="p-4 text-gray-700">${mainPollutant}</td>
                            <td class="p-4 text-gray-700">${measurementDate}</td>
                        </tr>
                    `;
                }

                // Sonra diğer şehirleri ekle
                allCityData.forEach(cityData => {
                    const { city, data } = cityData;
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    let rowContent = `<td class="p-4 font-semibold text-[#073B4C]">${city}</td>`;
                    if (data && data.aqi) {
                        const status = getAqiStatus(data.aqi);
                        const pollutantCode = (data.dominentpol || '-').toLowerCase();
                        const pollutantDescription = POLLUTANT_INFO[pollutantCode] || 'Baskın kirletici';
                        const measurementTime = data.time?.s ? new Date(data.time.s).toLocaleString('tr-TR') : '-';
                        rowContent += `
                            <td class="p-4 font-bold text-lg">${data.aqi}</td>
                            <td class="p-4"><span class="px-3 py-1 text-sm text-white rounded-full ${status.color}">${status.text}</span></td>
                            <td class="p-4 text-gray-700"><span title="${pollutantDescription}">${pollutantCode.toUpperCase()}</span></td>
                            <td class="p-4 text-gray-700">${measurementTime}</td>
                        `;
                    } else {
                        rowContent += `<td colspan="4" class="p-4 text-red-500">Veri alınamadı.</td>`;
                    }
                    row.innerHTML = rowContent;
                    tableBody.appendChild(row);
                });
            }
            
            const createChart = (ctx, datasets, suggestedMin, suggestedMax) => {
                if (!ctx) return null;
                return new Chart(ctx, { 
                    type: 'line', 
                    data: { labels: [], datasets: datasets }, 
                    options: { 
                        animation: false, 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        scales: { 
                            x: { type: 'time', time: { unit: 'second', displayFormats: { second: 'HH:mm:ss' } }, ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 10 }}, 
                            y: { beginAtZero: false, suggestedMin: suggestedMin, suggestedMax: suggestedMax }
                        }, 
                        plugins: { legend: { display: true } } 
                    } 
                });
            };

            const tempHumidityChart = createChart(document.getElementById('tempHumidityChart')?.getContext('2d'), [{ label: 'Sıcaklık (°C)', data: [], borderColor: '#FF6B6B', tension: 0.2 }, { label: 'Nem (%)', data: [], borderColor: '#118AB2', tension: 0.2 }], 10, 40);
            const co2Chart = createChart(document.getElementById('co2Chart')?.getContext('2d'), [{ label: 'CO₂ (ppm)', data: [], borderColor: '#06D6A0', tension: 0.2, fill: { target: 'origin', above: 'rgba(6, 214, 160, 0.1)'} }], 300, 2000);
            const tdsChart = createChart(document.getElementById('tdsChart')?.getContext('2d'), [{ label: 'TDS (ppm)', data: [], borderColor: '#EF476F', tension: 0.2, fill: { target: 'origin', above: 'rgba(239, 71, 111, 0.1)'} }], 50, 600);
            const lightChart = createChart(document.getElementById('lightChart')?.getContext('2d'), [{ label: 'Işık (lux)', data: [], borderColor: '#FFD166', tension: 0.2, fill: { target: 'origin', above: 'rgba(255, 209, 102, 0.1)'} }], 200, 900);

            function updateAllCharts(history) {
                lastHistoryData = history;
                const labels = [], tempData = [], humData = [], co2Data = [], tdsData = [], lightData = []; 
                history.forEach(dp => {
                    if (dp.timestamp && dp.timestamp.toDate) {
                        const timestamp = dp.timestamp.toDate();
                        labels.push(timestamp);
                        tempData.push(isNaN(dp.temperature) ? null : parseFloat(dp.temperature));
                        humData.push(isNaN(dp.humidity) ? null : parseFloat(dp.humidity));
                        co2Data.push(isNaN(dp.co2) ? null : parseFloat(dp.co2));
                        tdsData.push(isNaN(dp.tds_value) ? null : parseFloat(dp.tds_value));
                        lightData.push(isNaN(dp.light_value) ? null : parseFloat(dp.light_value));
                    }
                });
                if(tempHumidityChart) {
                    tempHumidityChart.data.labels = labels;
                    tempHumidityChart.data.datasets[0].data = tempData;
                    tempHumidityChart.data.datasets[1].data = humData;
                    tempHumidityChart.update();
                }
                if(co2Chart){
                    co2Chart.data.labels = labels;
                    co2Chart.data.datasets[0].data = co2Data;
                    co2Chart.update();
                }
                if(tdsChart){
                    tdsChart.data.labels = labels;
                    tdsChart.data.datasets[0].data = tdsData;
                    tdsChart.update();
                }
                if(lightChart){
                    lightChart.data.labels = labels;
                    lightChart.data.datasets[0].data = lightData;
                    lightChart.update();
                }
                
                updateEfficiencyAnalysis(history);
            }
            
            function updateEfficiencyAnalysis(history) {
                const analysisElement = document.getElementById('efficiency-analysis');
                if (!analysisElement || history.length < 3) {
                    if(analysisElement) analysisElement.innerHTML = `<p class="text-center">Yeterli veri toplanıyor...</p>`;
                    return;
                }

                const avg = (arr) => arr.length > 0 ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
                const avg_co2 = avg(history.map(d => parseFloat(d.co2)).filter(v => !isNaN(v)));
                const avg_light = avg(history.map(d => parseFloat(d.light_value)).filter(v => !isNaN(v)));
                const avg_tds = avg(history.map(d => parseFloat(d.tds_value)).filter(v => !isNaN(v)));
                const avg_temp = avg(history.map(d => parseFloat(d.temperature)).filter(v => !isNaN(v)));

                let comment = "";

                if (avg_co2 < 1000 && avg_light > 400) {
                    comment += "• <b>Oksijen Üretimi:</b> Mükemmel! Düşük CO₂ ve yeterli ışık seviyesi, alglerin verimli bir şekilde oksijen ürettiğini gösteriyor.<br><br>";
                } else if (avg_co2 < 1000) {
                    comment += "• <b>Oksijen Üretimi:</b> İyi. CO₂ seviyesi düşük, ancak daha fazla ışık ile verimlilik artabilir.<br><br>";
                } else {
                    comment += "• <b>Oksijen Üretimi:</b> Orta. CO₂ seviyesi biraz yüksek. Sistem havayı temizlemek için aktif olarak çalışıyor.<br><br>";
                }

                if (avg_tds > 100 && avg_tds < 500 && avg_light > 400) {
                    comment += "• <b>Biyokütle Verimliliği:</b> Harika! Su kalitesi (TDS) ve ışık seviyesi, biyokütle üretimi için ideal koşullarda.<br><br>";
                } else {
                    comment += "• <b>Biyokütle Verimliliği:</b> Geliştirilebilir. Su kalitesi veya ışık seviyesi, biyokütle üretimi için optimum aralığın dışında olabilir.<br><br>";
                }

                if (avg_temp > 20 && avg_temp < 30) {
                    comment += "• <b>Ortam Koşulları:</b> İdeal. Sıcaklık, alglerin sağlıklı gelişimi için uygun aralıkta.";
                } else {
                    comment += "• <b>Ortam Koşulları:</b> Dikkat. Sıcaklık, alglerin gelişimi için ideal aralığın dışında.";
                }
                
                analysisElement.innerHTML = comment;
            }

            function startRealtimeListeners() {
                const liveDataRef = doc(db, "artifacts/default-app-id/public/data/sensors/current_data");
                onSnapshot(liveDataRef, (docSnap) => {
                    if (docSnap.exists()) {
                        latestSensorData = docSnap.data();
                        const co2Value = parseFloat(latestSensorData.co2 || 0);

                        document.getElementById('kpi-co2').innerHTML = `${co2Value.toFixed(2)} <span class="text-lg">ppm</span>`;
                        
                        const airQuality = getAirQualityStatus(co2Value);
                        const airQualityElement = document.getElementById('kpi-air-quality');
                        airQualityElement.textContent = airQuality.text;
                        airQualityElement.className = `text-3xl font-black mt-1 ${airQuality.color}`; 
                        
                        document.getElementById('kpi-light').innerHTML = `${parseFloat(latestSensorData.light_value || 0).toFixed(0)} <span class="text-lg">lux</span>`;
                        document.getElementById('kpi-temp').innerHTML = `${parseFloat(latestSensorData.temperature || 0).toFixed(1)} <span class="text-lg">°C</span>`;
                        document.getElementById('kpi-humidity').innerHTML = `${parseFloat(latestSensorData.humidity || 0).toFixed(1)} <span class="text-lg">%</span>`;
                        document.getElementById('kpi-tds').innerHTML = `${parseFloat(latestSensorData.tds_value || 0).toFixed(1)} <span class="text-lg">ppm</span>`;
                        
                        updateComparisonTable();
                    }
                });
                const historyQuery = query(collection(db, "artifacts/default-app-id/public/data/sensor_history"), orderBy("timestamp", "desc"), limit(10));
                onSnapshot(historyQuery, (querySnapshot) => {
                    const historyData = querySnapshot.docs.map(doc => doc.data());
                    updateAllCharts(historyData.reverse());
                });
            }
            
            function downloadDataAsCSV() {
                if (lastHistoryData.length === 0) {
                    alert("İndirilecek veri bulunmuyor.");
                    return;
                }
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Tarih,Sıcaklık (°C),Nem (%),CO2 (ppm),TDS (ppm),Işık (lux)\r\n";
                lastHistoryData.forEach(row => {
                    const date = row.timestamp.toDate().toLocaleString('tr-TR');
                    csvContent += `${date},${row.temperature},${row.humidity},${row.co2},${row.tds_value || ''},${row.light_value || ''}\r\n`;
                });
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "sensor_verileri.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            document.getElementById('download-csv-button').addEventListener('click', downloadDataAsCSV);

            function setupAiChat() {
                const chatForm = document.getElementById('chat-form');
                const chatInput = document.getElementById('chat-input');
                const chatSubmit = document.getElementById('chat-submit');
                
                chatHistory.push({
                    role: "user",
                    parts: [{ text: "Sen, BIQ-Alg 0CO2 Temiz Hava İstasyonu için bir yapay zeka asistanısın. Sorulara projenin hedefleri ve sana verilecek anlık sensör verileri bağlamında, bilgilendirici ve pozitif bir tonda cevap ver." }]
                });
                 chatHistory.push({
                    role: "model",
                    parts: [{ text: "Anlaşıldı. BIQ-Alg projesi asistanı olarak, projenin hedefleri ve bana sağlanan anlık sensör verileri hakkında bilgilendirici ve pozitif yanıtlar vereceğim." }]
                });

                chatForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const userMessage = chatInput.value.trim();
                    if (!userMessage) return;

                    chatSubmit.disabled = true;
                    appendChatMessage(userMessage, 'user');
                    chatInput.value = '';
                    
                    const sensorDataContext = latestSensorData 
                        ? `Anlık Sensör Verileri: CO2=${latestSensorData.co2.toFixed(1)}ppm, Işık=${latestSensorData.light_value.toFixed(0)}lux, Sıcaklık=${latestSensorData.temperature.toFixed(1)}°C, Nem=${latestSensorData.humidity.toFixed(1)}%, TDS=${latestSensorData.tds_value.toFixed(1)}ppm. Bu bilgilere göre kullanıcının şu sorusunu cevapla: "${userMessage}"`
                        : `Kullanıcının sorusu: "${userMessage}"`;

                    chatHistory.push({ role: "user", parts: [{ text: sensorDataContext }] });

                    const thinkingElement = appendChatMessage('Yapay zeka düşünüyor...', 'ai', true);

                    try {
                        const payload = { contents: chatHistory };
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                             throw new Error(`API isteği başarısız oldu. Sunucu yanıtı: ${response.status}`);
                        }

                        const result = await response.json();
                        
                        if (result.candidates && result.candidates.length > 0) {
                            const aiResponse = result.candidates[0].content.parts[0].text;
                            thinkingElement.innerHTML = `<p>${aiResponse.replace(/\n/g, '<br>')}</p>`;
                            chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                        } else {
                            thinkingElement.innerHTML = `<p>Üzgünüm, bir yanıt alamadım. Lütfen tekrar deneyin.</p>`;
                        }

                    } catch (error) {
                        console.error("Yapay zeka sohbet hatası:", error);
                        thinkingElement.innerHTML = `<p>Üzgünüm, bir hata oluştu. Lütfen ağ bağlantınızı kontrol edin veya daha sonra tekrar deneyin. (Hata: ${error.message})</p>`;
                    } finally {
                        chatSubmit.disabled = false;
                    }
                });
            }

            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('main section');
            window.addEventListener('scroll', () => { 
                let current = "hero"; 
                sections.forEach(section => { 
                    const sectionTop = section.offsetTop; 
                    if (window.pageYOffset >= sectionTop - 75) { 
                        current = section.getAttribute('id'); 
                    } 
                }); 
                navLinks.forEach(link => { 
                    link.classList.remove('active'); 
                    if (link.href && link.href.includes(current)) { 
                        link.classList.add('active'); 
                    } 
                }); 
            });

            const pbrPerformanceChartCtx = document.getElementById('pbrPerformanceChart')?.getContext('2d');
            if(pbrPerformanceChartCtx) {
                new Chart(pbrPerformanceChartCtx, { type: 'bar', data: { labels: ['Biyokütle Verimliliği (g/L/gün)', 'Maks. Biyokütle Yoğunluğu (g/L)'], datasets: [{ label: 'Dikey Tübüler FBR', data: [1.65, 20.0], backgroundColor: '#118AB2' }, { label: 'Düz Panel FBR', data: [4.8, 26.6], backgroundColor: '#06D6A0' }, { label: 'Açık Havuz', data: [0.3, 1.5], backgroundColor: '#FFD166' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'Değer' } } }, plugins: { title: { display: true, text: 'Farklı FBR Teknolojilerinin Performans Karşılaştırması' } } } });
            }
        
        });
    </script>
</body>
</html>
