<!DOCTYPE html>
<html lang="tr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIQ-Alg 0CO2: Canlı Veri Paneli</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Montserrat:wght@700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f8f9fa; color: #073B4C; }
        .font-heading { font-family: 'Montserrat', sans-serif; }
        .chart-container { position: relative; width: 100%; height: 320px; }
        .kpi-card { background: #ffffff; border-radius: 0.75rem; padding: 1rem; text-align: center; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
    </style>
</head>

<body class="antialiased">

    <header class="bg-white/95 backdrop-blur-sm sticky top-0 z-50 shadow-md">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="#" class="flex items-center">
                <img src="logo111.png" alt="BIQ-Alg 0CO2 Proje Logosu" class="h-12 w-auto" onerror="this.onerror=null; this.src='https://placehold.co/150x50/FFFFFF/073B4C?text=BiQ-Alg+0CO2';">
            </a>
            <div class="hidden md:flex items-center space-x-8">
                <a href="#" class="nav-link text-gray-600 hover:text-[#118AB2] font-semibold transition-colors">Çözüm</a>
                <a href="#" class="nav-link text-gray-600 hover:text-[#118AB2] font-semibold transition-colors">Teknoloji</a>
                <a href="#" class="nav-link text-gray-600 hover:text-[#118AB2] font-semibold transition-colors active">Canlı Veri</a>
                <a href="#" class="nav-link text-gray-600 hover:text-[#118AB2] font-semibold transition-colors">Özet</a>
                <a href="#" class="nav-link text-gray-600 hover:text-[#118AB2] font-semibold transition-colors">Gelecek</a>
            </div>
        </nav>
    </header>

    <main>
        <section id="live-data" class="py-16 md:py-24">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12 md:mb-16">
                    <h2 class="text-3xl md:text-4xl font-bold font-heading text-[#073B4C]">Canlı Veri İzleme Paneli</h2>
                    <p class="mt-4 text-lg text-[#073B4C] max-w-3xl mx-auto">
                        BIQ-Alg 0CO2 istasyonundan gelen gerçek zamanlı sensör verilerini buradan takip edin. Bu panel, sistemin anlık performansını ve çevre koşullarını gösterir.
                    </p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8 text-center">
                    <div class="kpi-card p-4 rounded-lg shadow-md"><h4 class="font-bold text-gray-500 text-sm">CO₂ SEVİYESİ</h4><p id="kpi-co2" class="text-3xl font-black text-[#118AB2] mt-1">--- <span class="text-lg">ppm</span></p></div>
                    <div class="kpi-card p-4 rounded-lg shadow-md"><h4 class="font-bold text-gray-500 text-sm">HAVA KALİTESİ</h4><p id="kpi-mq135" class="text-3xl font-black text-[#06D6A0] mt-1">---</p></div>
                    <div class="kpi-card p-4 rounded-lg shadow-md"><h4 class="font-bold text-gray-500 text-sm">IŞIK ŞİDDETİ</h4><p id="kpi-light" class="text-3xl font-black text-[#FFD166] mt-1">--- <span class="text-lg">lux</span></p></div>
                    <div class="kpi-card p-4 rounded-lg shadow-md"><h4 class="font-bold text-gray-500 text-sm">SICAKLIK</h4><p id="kpi-temp" class="text-3xl font-black text-[#FF6B6B] mt-1">-- <span class="text-lg">°C</span></p></div>
                    <div class="kpi-card p-4 rounded-lg shadow-md"><h4 class="font-bold text-gray-500 text-sm">NEM</h4><p id="kpi-humidity" class="text-3xl font-black text-[#118AB2] mt-1">-- <span class="text-lg">%</span></p></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-bold font-heading text-center mb-4 text-[#073B4C]">Sıcaklık ve Nem Trendi (Son 10 Okuma)</h3><div class="chart-container"><canvas id="tempHumidityChart"></canvas></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-bold font-heading text-center mb-4 text-[#073B4C]">CO₂ Seviyesi Trendi (Son 10 Okuma)</h3><div class="chart-container"><canvas id="co2Chart"></canvas></div></div>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-[#073B4C] text-white py-8 mt-16">
        <div class="container mx-auto px-6 text-center"><p>&copy; 2025 BIQ-Alg 0CO2 Projesi. Tüm Hakları Saklıdır.</p></div>
    </footer>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, collection, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', function () {
            
            const firebaseConfig = {
                apiKey: "AIzaSyBvJNWLHjMqlhAdZXSBqHQuPNnnImNZd4Q",
                authDomain: "biqalgco2-hava-istasyonu.firebaseapp.com",
                projectId: "biqalgco2-hava-istasyonu",
                storageBucket: "biqalgco2-hava-istasyonu.appspot.com",
                messagingSenderId: "1014289654311",
                appId: "1:1014289654311:web:e37e2a3ffe78a3cc4ba402"
            };
            
            let db;
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const auth = getAuth(app);
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        startRealtimeListeners();
                    } else {
                        signInAnonymously(auth);
                    }
                });
            } catch(e) { console.error("Firebase başlatma hatası:", e); }
            
            const createChart = (ctx, type, datasets) => new Chart(ctx, { type: type, data: { labels: [], datasets: datasets }, options: { responsive: true, maintainAspectRatio: false, animation: { duration: 400 }, scales: { x: { type: 'time', time: { unit: 'second', displayFormats: { second: 'HH:mm:ss' } }, ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 7 }}, y: { beginAtZero: false } }, plugins: { legend: { display: true } } } });
            const tempHumidityCtx = document.getElementById('tempHumidityChart')?.getContext('2d');
            const co2Ctx = document.getElementById('co2Chart')?.getContext('2d');
            let tempHumidityChart = tempHumidityCtx ? createChart(tempHumidityCtx, 'line', [{ label: 'Sıcaklık (°C)', data: [], borderColor: '#FF6B6B', tension: 0.2 }, { label: 'Nem (%)', data: [], borderColor: '#118AB2', tension: 0.2 }]) : null;
            let co2Chart = co2Ctx ? createChart(co2Ctx, 'line', [{ label: 'CO₂ (ppm)', data: [], borderColor: '#06D6A0', tension: 0.2, fill: { target: 'origin', above: 'rgba(6, 214, 160, 0.1)'} }]) : null;
            
            function updateAllCharts(historyData) {
                if (!historyData) return;
                const labels = [], tempData = [], humData = [], co2Data = [];

                historyData.forEach(dataPoint => {
                    if (dataPoint && dataPoint.timestamp) {
                        labels.push(dataPoint.timestamp.toDate());
                        tempData.push(dataPoint.temperature);
                        humData.push(dataPoint.humidity);
                        co2Data.push(dataPoint.co2);
                    }
                });
                
                if (tempHumidityChart) {
                    tempHumidityChart.data.labels = labels;
                    tempHumidityChart.data.datasets[0].data = tempData;
                    tempHumidityChart.data.datasets[1].data = humData;
                    tempHumidityChart.update();
                }
                if (co2Chart) {
                    co2Chart.data.labels = labels;
                    co2Chart.data.datasets[0].data = co2Data;
                    co2Chart.update();
                }
            }

            function startRealtimeListeners() {
                // Anlık KPI kartları için dinleyici
                const liveDataRef = doc(db, "artifacts/default-app-id/public/data/sensors/current_data");
                onSnapshot(liveDataRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        const temp = data.temperature || '--';
                        const hum = data.humidity || '--';
                        const co2 = data.co2 || '---';
                        const mq135 = data.mq135_value || '---';
                        const light = data.light_value || '---';

                        document.getElementById('kpi-co2').innerHTML = `${co2} <span class="text-lg">ppm</span>`;
                        document.getElementById('kpi-mq135').textContent = mq135 !== '---' ? (parseInt(mq135) < 300 ? 'İyi' : 'Kontrol') : '---';
                        document.getElementById('kpi-light').innerHTML = `${light} <span class="text-lg">lux</span>`;
                        document.getElementById('kpi-temp').innerHTML = `${parseFloat(temp).toFixed(1)} <span class="text-lg">°C</span>`;
                        document.getElementById('kpi-humidity').innerHTML = `${parseFloat(hum).toFixed(1)} <span class="text-lg">%</span>`;
                    }
                });

                // Grafik için geçmiş verisini dinleyen sorgu
                const historyCollectionRef = collection(db, "artifacts/default-app-id/public/data/sensor_history");
                const historyQuery = query(historyCollectionRef, orderBy("timestamp", "desc"), limit(10));
                
                onSnapshot(historyQuery, (querySnapshot) => {
                    const historyData = [];
                    querySnapshot.forEach((doc) => {
                        historyData.push(doc.data());
                    });
                    updateAllCharts(historyData.reverse());
                });
            }
        });
    </script>
</body>
</html>
